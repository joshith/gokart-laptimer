<html>
<head>
<title>Gokart Session</title>
</head>
<style type="text/css">
.tg {
	border-collapse: collapse;
	border-spacing: 0;
	border-color: #aabcfe;
}

.tg td {
	font-family: Arial, sans-serif;
	font-size: 14px;
	padding: 10px 5px;
	border-style: solid;
	border-width: 1px;
	overflow: hidden;
	word-break: normal;
	border-color: #aabcfe;
	color: #669;
	background-color: #e8edff;
}

.tg th {
	font-family: Arial, sans-serif;
	font-size: 14px;
	font-weight: normal;
	padding: 10px 5px;
	border-style: solid;
	border-width: 1px;
	overflow: hidden;
	word-break: normal;
	border-color: #aabcfe;
	color: #039;
	background-color: #b9c9fe;
}

.tg .tg-vn4c {
	background-color: #D2E4FC
}

.tg .tg-2fkl {
	font-weight: bold;
	font-size: 36px;
	text-align: center
}

.tg .tg-if22 {
	background-color: #D2E4FC;
	font-weight: bold;
	font-size: 22px
}

.tg .tg-5rcs {
	font-weight: bold;
	font-size: 20px
}

.tg .tg-sh0f {
	font-weight: bold;
	font-size: 20px;
	text-align: right
}

.tg .tg-m08s {
	background-color: #D2E4FC;
	font-weight: bold;
	font-size: 20px
}

.button {
	border: 1px solid #0a3c59;
	background: #3e779d;
	background: -webkit-gradient(linear, left top, left bottom, from(#65a9d7),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #65a9d7, #3e779d);
	background: -moz-linear-gradient(top, #65a9d7, #3e779d);
	background: -ms-linear-gradient(top, #65a9d7, #3e779d);
	background: -o-linear-gradient(top, #65a9d7, #3e779d);
	background-image: -ms-linear-gradient(top, #65a9d7 0%, #3e779d 100%);
	padding: 10.5px 21px;
	-webkit-border-radius: 6px;
	-moz-border-radius: 6px;
	border-radius: 6px;
	-webkit-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	-moz-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	text-shadow: #7ea4bd 0 1px 0;
	color: #06426c;
	font-size: 14px;
	font-family: helvetica, serif;
	text-decoration: none;
	vertical-align: middle;
}

.button:hover {
	border: 1px solid #0a3c59;
	text-shadow: #1e4158 0 1px 0;
	background: #3e779d;
	background: -webkit-gradient(linear, left top, left bottom, from(#65a9d7),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #65a9d7, #3e779d);
	background: -moz-linear-gradient(top, #65a9d7, #3e779d);
	background: -ms-linear-gradient(top, #65a9d7, #3e779d);
	background: -o-linear-gradient(top, #65a9d7, #3e779d);
	background-image: -ms-linear-gradient(top, #65a9d7 0%, #3e779d 100%);
	color: #fff;
}

.button:active {
	text-shadow: #1e4158 0 1px 0;
	border: 1px solid #0a3c59;
	background: #65a9d7;
	background: -webkit-gradient(linear, left top, left bottom, from(#3e779d),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #3e779d, #65a9d7);
	background: -moz-linear-gradient(top, #3e779d, #65a9d7);
	background: -ms-linear-gradient(top, #3e779d, #65a9d7);
	background: -o-linear-gradient(top, #3e779d, #65a9d7);
	background-image: -ms-linear-gradient(top, #3e779d 0%, #65a9d7 100%);
	color: #fff;
}

.button:disabled {
	text-shadow: #1e4158 0 1px 0;
	border: 1px solid #0a3c59;
	background: #65a9d7;
	background: -webkit-gradient(linear, left top, left bottom, from(#3a779d),
		to(#3a779d) );
	background: -webkit-linear-gradient(top, #3a779d, #65a9d7);
	background: -moz-linear-gradient(top, #3a779d, #65a9d7);
	background: -ms-linear-gradient(top, #3a779d, #65a9d7);
	background: -o-linear-gradient(top, #3a779d, #65a9d7);
	background-image: -ms-linear-gradient(top, #3e779d 0%, #65a9d7 100%);
	color: #fff;
}

.button2 {
	border: 1px solid #0a3c59;
	background: #c7473b;
	background: -webkit-gradient(linear, left top, left bottom, from(#c7473b),
		to(#f27413) );
	background: -webkit-linear-gradient(top, #c7473b, #f27413);
	background: -moz-linear-gradient(top, #c7473b, #f27413);
	background: -ms-linear-gradient(top, #c7473b, #f27413);
	background: -o-linear-gradient(top, #c7473b, #f27413);
	background-image: -ms-linear-gradient(top, #c7473b 0%, #f27413 100%);
	padding: 10.5px 21px;
	-webkit-border-radius: 6px;
	-moz-border-radius: 6px;
	border-radius: 6px;
	-webkit-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	-moz-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	text-shadow: #7ea4bd 0 1px 0;
	color: #fff;
	font-size: 14px;
	font-family: helvetica, serif;
	text-decoration: none;
	vertical-align: middle;
}

.button2:hover {
	border: 1px solid #0a3c59;
	text-shadow: #1e4158 0 1px 0;
	background: #3e779d;
	background: -webkit-gradient(linear, left top, left bottom, from(#c7473b),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #c7473b, #f27413);
	background: -moz-linear-gradient(top, #c7473b, #f27413);
	background: -ms-linear-gradient(top, #c7473b, #f27413);
	background: -o-linear-gradient(top, #c7473b, #f27413);
	background-image: -ms-linear-gradient(top, #c7473b 0%, #f27413 100%);
	color: #06426c;
}

.button2:active {
	text-shadow: #1e4158 0 1px 0;
	border: 1px solid #0a3c59;
	background: #65a9d7;
	background: -webkit-gradient(linear, left top, left bottom, from(#3e779d),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #3e779d, #65a9d7);
	background: -moz-linear-gradient(top, #3e779d, #65a9d7);
	background: -ms-linear-gradient(top, #3e779d, #65a9d7);
	background: -o-linear-gradient(top, #3e779d, #65a9d7);
	background-image: -ms-linear-gradient(top, #3e779d 0%, #65a9d7 100%);
	color: #ffff;
}

input[type="text"]:disabled {
	background: #ffffff;
}
</style>

<?php
global $Started;
global $kart_drv_name;
$defaultName = "Name";
$UPLOAD_DIR = "uploads/";

$kart_drv_name = include($_SERVER['DOCUMENT_ROOT']."/config.php");

//$kart_drv_name = array ($defaultName, $defaultName, $defaultName, $defaultName,
//						$defaultName, $defaultName, $defaultName, $defaultName);

function sendHttpRequest_internal($cmd) {
	global $kart_drv_name;

	if (empty($kart_drv_name['SRV_IP'])) {
		if(empty($kart_drv_name['SRV_NAME'])) {
			echo "invalid hostname and ip:".$kart_drv_name['SRV_NAME']."<br>";
			return FALSE;
		}
		$host_ip = gethostbyname ($kart_drv_name['SRV_NAME']);
		if (!empty($host_ip)) {
			echo "host IP resolved for hostname and ip:".$kart_drv_name['SRV_NAME'].$host_ip."<br>";
			$kart_drv_name['SRV_IP'] = $host_ip;
		} else {
			echo "gethostbyname failure on host:".$kart_drv_name['SRV_NAME']."<br>";
			return FALSE;
		}
	} else {
		$host_ip = $kart_drv_name['SRV_IP'];
	}

	$port = $kart_drv_name['SRV_PORT'];
	if(empty($port)) {
		echo "invalid port for host".$kart_drv_name['SRV_NAME'].$kart_drv_name['SRV_PORT']."<br>";
		return FALSE;
	}

	if (!($fp = fsockopen($host_ip, $port))) {
		echo "Could not connect to server:".$host_ip."<br>";
		return FALSE;
	}

	//  construct request
	//if ($cmd != "START" && $cmd != "STOP" && $cmd != "STATUS") {
	//echo "Invalid request cmd:".$cmd."<br>";
	//return FALSE;
	//}

	$request = "GET ".$cmd." HTTP/1.1\r\n";
	//$request = "GET HTTP/1.1\r\n";
	//	echo "request:".$request."<br>";

	//  write request to socket
	fwrite($fp, $request);

	//  read the status line
	$line  = fgets($fp, 2048);
	if(FALSE !== strpos($line, "200 OK")) {
		//		echo "status OK Recvd: ".$line."<br>";
		fclose ($fp);
		return TRUE;
	}
	//$status = explode(" ", $line);
	$line = "";
	while (!feof($fp)) {
		$line .= fgets($fp, 2048);
	}
	echo "command failed! Recvd:".$line."<br>";
	return FALSE;
}

function sendHttpRequest($cmd) {
	return sendHttprequest_internal($cmd);
	//return True;
}

// Cleanup session data
function cleanupSession ($devName) {
	// Get the configured names
	global $UPLOAD_DIR;
	
	//if the dir doesn't exist, return
	if(False === is_dir($UPLOAD_DIR)) {
		return;
	}
	
	$dir = new DirectoryIterator($UPLOAD_DIR);
	foreach ($dir as $fileinfo) {
		if ($fileinfo->isDot()) {
			continue;
		}
		$file = $fileinfo->getPathname();
		if($devName != "all" && (false === strpos($file, $devName))) {
			continue;
		}
		//		echo $file."<br>";
		unlink ($file);
	}
}

//if (FALSE == sendHttpRequest("STATUS:") ) {
//	echo "Failed to send STATUS request <br>";
//}

function handleSwitch($devName, $textBoxName) {
	global $kart_drv_name;
	$ret = TRUE;

	if (($kart_drv_name['STARTED'.$devName]	== False)) {
		$kart_drv_name[$devName] = $_POST[$textBoxName];
	}

	if ("Server" != $_POST['serverName']) {
		$kart_drv_name['SRV_NAME'] = $_POST['serverName'];
	}
	if ("Ip" != $_POST['serverIp']) {
		$kart_drv_name['SRV_IP'] = $_POST['serverIp'];
	}
	if ("Port" != $_POST['serverPort']) {
		$kart_drv_name['SRV_PORT'] = $_POST['serverPort'];
	}

	//echo("StartBtn: " . $kart_drv_name['DEV1'] . "<br/>\n\n");

	if($kart_drv_name['STARTED'.$devName] == True) {
		($kart_drv_name['STARTED'.$devName]	= False);
		//cleanup the session for the device
		cleanupSession ($devName);
		// Send stop command
		if (FALSE == sendHttpRequest("STOP:".$devName.":") ) {
			echo "Failed to send STOP request for DEV1<br>";
			$ret = FALSE;
		}
	} else {
		($kart_drv_name['STARTED'.$devName] = True);
		// Send Start command
		if (FALSE == sendHttpRequest("START:".$devName.":") ) {
			echo "Failed to send START request for DEV1 <br>";
			$ret = FALSE;
		}
	}

	// store the config
	file_put_contents('config.php', '<?php return ' . var_export($kart_drv_name, true) . ';');
	return $ret;
}

//$Started = False;
if ( isset($_POST["Dev1Btn"])){
	handleSwitch ('DEV1', 'kart1Text');
}

if ( isset($_POST["Dev2Btn"])){
	handleSwitch ('DEV2', 'kart2Text');
}

if ( isset($_POST["Dev3Btn"])){
	handleSwitch ('DEV3', 'kart3Text');
}

if ( isset($_POST["Dev4Btn"])){
	handleSwitch ('DEV4', 'kart4Text');
}

if ( isset($_POST["Dev5Btn"])){
	handleSwitch ('DEV5', 'kart5Text');
}

if ( isset($_POST["Dev6Btn"])){
	handleSwitch ('DEV6', 'kart6Text');
}

if ( isset($_POST["Dev7Btn"])){
	handleSwitch ('DEV7', 'kart7Text');
}

if ( isset($_POST["Dev8Btn"])){
	handleSwitch ('DEV8', 'kart8Text');
}


if (isset($_POST["newBtn"])) {
	//echo ("new session: <br/>\n\n");
	// cleanup the session data
	cleanupSession ("all");
	// Clear the driver names
	foreach ($kart_drv_name as $key => $val ) {

		if(FALSE !== strpos($key, 'STARTED')) {
			$kart_drv_name[$key] = false;
			continue;
		}
		if ($key == 'SRV_NAME' || $key == 'SRV_IP' ||
		$key == 'SRV_PORT') {
			continue;
		}

		$kart_drv_name[$key] = $defaultName;
	}
	// store the config
	file_put_contents('config.php', '<?php return ' . var_export($kart_drv_name, true) . ';');
}
?>

<form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">
	<table class="tg">
		<tr>
			<th class="tg-2fkl" colspan="4">Session Entry</th>
		</tr>
		<tr>
			<td class="tg-if22">Kart No</td>
			<td class="tg-if22">Driver Name</td>
			<td class="tg-if22" align="center">Lap <br> #</td>
			<td class="tg-if22"></td>
		</tr>
		<tr>
			<td class="tg-5rcs" align="center">1</td>
			<td class="tg-5rcs"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART1']; ?> name="kart1Text"
				maxlength="15" style="background-color: #D2E4FC;"
<?php if($kart_drv_name['STARTEDDEV1'] == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-sh0f" align="center"></td>
			<td class="tg-sh0f" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART1'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev1Btn"
				<?php if($kart_drv_name['STARTEDKART1'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>

		</tr>
		<tr>
			<td class="tg-m08s" align="center">2</td>
			<td class="tg-vn4c"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART2'] ?> name="kart2Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-vn4c" align="center"></td>
			<td class="tg-vn4c" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART2'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev2Btn"
				<?php if($kart_drv_name['STARTEDKART2'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
		<tr>
			<td class="tg-5rcs" align="center">3</td>
			<td class="tg-031e"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART3'] ?> name="kart3Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-031e" align="center"></td>
			<td class="tg-031e" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART3'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev3Btn"
				<?php if($kart_drv_name['STARTEDKART3'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
		<tr>
			<td class="tg-m08s" align="center">4</td>
			<td class="tg-vn4c"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART4'] ?> name="kart4Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-vn4c" align="center"></td>
			<td class="tg-vn4c" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART4'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev4Btn"
				<?php if($kart_drv_name['STARTEDKART4'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
		<tr>
			<td class="tg-5rcs" align="center">5</td>
			<td class="tg-031e"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART5'] ?> name="kart5Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-031e" align="center"></td>
			<td class="tg-031e" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART5'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev5Btn"
				<?php if($kart_drv_name['STARTEDKART5'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
		<tr>
			<td class="tg-m08s" align="center">6</td>
			<td class="tg-m08s"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART6'] ?> name="kart6Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-vn4c" align="center"></td>
			<td class="tg-vn4c" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART6'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev6Btn"
				<?php if($kart_drv_name['STARTEDKART6'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
		<tr>
			<td class="tg-5rcs" align="center">7</td>
			<td class="tg-031e"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART7'] ?> name="kart7Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-031e" align="center"></td>
			<td class="tg-031e" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART7'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev7Btn"
				<?php if($kart_drv_name['STARTEDKART7'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
		<tr>
			<td class="tg-m08s" align="center">8</td>
			<td class="tg-vn4c"><input type="text" size=20
				Value=<?php echo $kart_drv_name['KART8'] ?> name="kart8Text"
				maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-vn4c" align="center"></td>
			<td class="tg-vn4" align="center"><input type="submit"
			<?php if($kart_drv_name['STARTEDKART8'] == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";} ?>
				name="Dev8Btn"
				<?php if($kart_drv_name['STARTEDKART8'] == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";} ?>
			
			</td>
		</tr>
	</table>
	<br>
	<table class="tg">
		<tr>
			<th class="tg-if22" colspan="3">Server Details</th>
		</tr>
		<tr>
			<td class="tg-if22">Server Name</td>
			<td class="tg-if22">Server IP</td>
			<td class="tg-if22">Port</td>
		</tr>
		<tr>
			<td class="tg-5rcs"><input type="text" size=20
				Value=<?php if (empty($kart_drv_name['SRV_NAME'])) {echo "Server";} else {echo $kart_drv_name['SRV_NAME'];} ?>
				name="serverName" maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-5rcs"><input type="text" size=20
				Value=<?php if (empty($kart_drv_name['SRV_IP'])) {echo "Ip";} else {echo $kart_drv_name['SRV_IP'];} ?>
				name="serverIp" maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
			<td class="tg-5rcs"><input type="text" size=20
				Value=<?php if (empty($kart_drv_name['SRV_PORT'])) {echo "Port";} else {echo $kart_drv_name['SRV_PORT'];} ?>
				name="serverPort" maxlength="15" style="background-color: #D2E4FC;"
				<?php if($Started == True){echo "disabled />";} else {echo "/>";} ?>
			
			</td>
		</tr>
	</table>
	<br> <input type="submit" Value="New Session" class="button"
		name="newBtn" />

</form>
<script type="text/javascript" src="jquery-1.11.2.min.js"> </script>
<script>
var auto_refresh = setInterval(
		function()
		{
			$('#status_query').load('status_query.php');
		}, 5000);
		$(document).ready(function(){
			$('#status_query').load('status_query.php')
		})
</script>

<body>
	<div id="status_query" align="center"></div>
</body>


</html>
